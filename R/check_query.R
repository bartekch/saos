# checking correctness of query
check_query <- function(query){
  # remove NULLs
  #query <- query[!vapply(query, is.null, logical(1))]
  # 
  # checking dates
  query$judgmentDateFrom <- check_date(query$judgmentDateFrom)
  query$judgmentDateTo <- check_date(query$judgmentDateTo)
  
  # checking natural values
  query$ccCourtId <- check_natural(query$ccCourtId)
  query$ccDivisionId <- check_natural(query$ccDivisionId)
  query$scChamberId <- check_natural(query$scChamberId)
  query$scDivisionId <- check_natural(query$scDivisionId)
  
  # checking sort
  query$sortingField <- match.arg(toupper(query$sortingField),
                                  c("DATABASE_ID", "JUDGMENT_DATE", "CASE_NUMBER",
                                    "CC_COURT_TYPE", "CC_COURT_ID", "CC_COURT_CODE",
                                    "CC_COURT_NAME", "CC_COURT_DIVISION_ID",
                                    "CC_COURT_DIVISION_CODE", "CC_COURT_DIVISION_NAME",
                                    "SC_JUDGMENT_FORM", "SC_PERSONNEL_TYPE", 
                                    "SC_COURT_DIVISION_ID", "SC_COURT_DIVISION_NAME",
                                    "SC_COURT_DIVISIONS_CHAMBER_ID",
                                    "SC_COURT_DIVISIONS_CHAMBER_NAME"))
  query$sortingDirection <- match.arg(toupper(query$sortingDirection), c("ASC", "DESC"))
  
  # check arguments with predefined list of values and single value allowed only
  if (!is.null(query$courtType)){
    query$courtType <- match.arg(toupper(query$courtType),
                               c("COMMON", "SUPREME","ADMINISTRATIVE",
                                 "CONSTITUTIONAL_TRIBUNAL", 
                                 "NATIONAL_APPEAL_CHAMBER"))
  }
  if (!is.null(query$ccCourtType)){
    query$ccCourtType <- match.arg(toupper(query$ccCourtType),
                                   c("APPEAL", "REGIONAL", "DISTRICT"))
  }
  if (!is.null(query$scPersonnelType)){
    query$scPersonnelType <- match.arg(toupper(query$scPersonnelType),
                                       c("ONE_PERSON", "THREE_PERSON", "FIVE_PERSON",
                                         "SEVEN_PERSON", "ALL_COURT", "ALL_CHAMBER",
                                         "JOINED_CHAMBERS"))
  }
  if (!is.null(query$judgmentTypes)){
    query$judgmentTypes <- match.arg(toupper(query$judgmentTypes),
                                     c("DECISION", "RESOLUTION", "SENTENCE",
                                       "REGULATION", "REASONS"))
  }
  
  # check the rest of arguments - in future query language must be implemened somehow
  query$all <- check_arg(query$all)
  query$legalBase <- check_arg(query$legalBase)
  query$referencedRegulation <- check_arg(query$referencedRegulation)
  query$judgeName <- check_arg(query$judgeName)
  query$caseNumber <- check_arg(query$caseNumber)
  query$ccCourtCode <- check_arg(query$ccCourtCode)
  query$ccCourtName <- check_arg(query$ccCourtName)
  query$ccDivisionCode <- check_arg(query$ccDivisionCode)
  query$ccDivisionName <- check_arg(query$ccDivisionName)
  query$scChamberName <- check_arg(query$scChamberName)
  query$scDivisionName <- check_arg(query$scDivisionName)
  query$keywords <- check_arg(query$keywords)
  
  return(query)
}


check_date <- function(date, format = "%Y-%m-%d"){
  argname <- tail(strsplit(deparse(substitute(date)), "\\$")[[1]], 1)
  
  if (is.null(date)) return(date)
  if (is.na(date)) stop(sprintf("%s cannot be NA", argname), call. = FALSE)
  
  if (length(date) > 1) 
    stop(sprintf("Argument %s has to be length one.", argname), call. = FALSE)
  
  if (is.character(date)) {
    date <- as.POSIXct(date, format = format)
    
    if (is.na(date))
      stop(sprintf("Wrong %s format, should be %s.", argname, format), 
           call. = FALSE)
    
  } else {
    date <- try(as.POSIXct(date, format = format), silent = TRUE)
    
    if (inherits(date, "try-error"))
      stop(sprintf("%s cannot be coerced to POSIXt.", argname), call. = FALSE)
  }
  
  date <- format(date, format = format)
  
  return(date)
}


check_natural <- function(x){
  argname <- tail(strsplit(deparse(substitute(x)), "\\$")[[1]], 1)
  
  if (is.null(x)) return(x)
  
  if (length(x) > 1) 
    stop(sprintf("Argument %s has to be length one.", argname), call. = FALSE)
  
  if (!is.numeric(x)) 
    stop(sprintf("Argument %s has to be numeric.", argname), call. = FALSE)
  
  if (x <= 0) 
    stop(sprintf("Argument %s has to be positive.", argname), call. = FALSE)
  
  if (abs(x - round(x)) > .Machine$double.eps^0.5) 
    stop(sprintf("Argument %s has to be natural number.", argname),
         call. = FALSE)
  x
}


check_arg <- function(x){
  argname <- tail(strsplit(deparse(substitute(x)), "\\$")[[1]], 1)
  
  if (is.null(x)) return(x)
  
  if (length(x) > 1) stop(sprintf("Argument %s has to be length one.", argname),
                          call. = FALSE)
  
  if (!is.character(x)) stop(sprintf("Argument %s has to be character.", argname),
                             call. = FALSE)
  x
}